{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Detail - Comment System Test</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/all.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    
    <style>
        body {
            padding: 50px 0;
            background: #f8f9fa;
        }
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .comments.replied {
            margin-left: 50px;
            margin-top: 20px;
            padding-left: 20px;
            border-left: 3px solid #e9ecef;
        }
        #reply-info {
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="mb-4">{{post.title}}</h1>
        <p class="text-muted">Posted on {{post.date|date:"F d, Y"}} by {{post.author}}</p>
        
        <hr class="my-5">

        <!-- section header -->
        <div class="section-header">
            <h3 class="section-title">Comments ({{ comments.count }})</h3>
            <img src="{% static 'images/wave.svg' %}" class="wave" alt="wave" />
        </div>

        <!-- post comments -->
        <div class="comments bordered padding-30 rounded">
            <ul class="comments">
                {% for comment in comments %}
                <li class="comment rounded">
                    <div class="thumb">
                        <img src="{% static 'images/other/comment-1.png' %}" alt="{{ comment.name }}" />
                    </div>
                    <div class="details">
                        <h4 class="name"><a href="#">{{ comment.name }}</a></h4>
                        <span class="date">{{ comment.date|date:"F d, Y - h:i A" }}</span>
                        <p>{{ comment.comment }}</p>
                        <a href="#comment-form" 
                           class="btn btn-default btn-sm reply-btn" 
                           data-comment-id="{{ comment.id }}" 
                           data-comment-name="{{ comment.name }}">
                           Reply
                        </a>
                        
                        <!-- Display nested replies -->
                        {% if comment.replies.all %}
                        <ul class="comments replied">
                            {% for reply in comment.replies.all %}
                            <li class="comment child rounded">
                                <div class="thumb">
                                    <img src="{% static 'images/other/comment-1.png' %}" alt="{{ reply.name }}" />
                                </div>
                                <div class="details">
                                    <h4 class="name"><a href="#">{{ reply.name }}</a></h4>
                                    <span class="date">{{ reply.date|date:"F d, Y - h:i A" }}</span>
                                    <p>{{ reply.comment }}</p>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </li>
                {% empty %}
                <li class="text-center py-5">
                    <p class="text-muted">No comments yet. Be the first to share your thoughts!</p>
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="spacer" data-height="50"></div>

        <!-- section header -->
        <div class="section-header">
            <h3 class="section-title">Leave a Comment</h3>
            <img src="{% static 'images/wave.svg' %}" class="wave" alt="wave" />
        </div>

        <!-- comment form -->
        <div class="comment-form rounded bordered padding-30" id="comment-form">
            <!-- Reply indicator -->
            <div id="reply-info" style="display:none; margin-bottom:20px; padding:15px; background:#e7f3ff; border-radius:8px; border-left:4px solid #007bff;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-reply" style="color:#007bff; margin-right:10px;"></i>
                        <strong>Replying to:</strong> <span id="reply-name" style="color:#007bff;"></span>
                    </div>
                    <button type="button" 
                            onclick="cancelReply()" 
                            class="btn-close" 
                            aria-label="Cancel">
                    </button>
                </div>
            </div>

            <form method="post" action="{% url 'add_comment' post.blog_slug %}">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <label for="InputComment" class="form-label">Comment *</label>
                            <textarea name="InputComment" 
                                      id="InputComment" 
                                      class="form-control" 
                                      rows="5" 
                                      placeholder="Share your thoughts..." 
                                      required></textarea>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label for="InputName" class="form-label">Name *</label>
                            <input type="text" 
                                   class="form-control" 
                                   name="InputName" 
                                   id="InputName" 
                                   placeholder="Your name" 
                                   required>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label for="InputEmail" class="form-label">Email *</label>
                            <input type="email" 
                                   class="form-control" 
                                   name="InputEmail" 
                                   id="InputEmail" 
                                   placeholder="your@email.com" 
                                   required>
                        </div>
                    </div>
                    
                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <label for="InputWeb" class="form-label">Website (Optional)</label>
                            <input type="url" 
                                   class="form-control" 
                                   name="InputWeb" 
                                   id="InputWeb" 
                                   placeholder="https://yourwebsite.com">
                        </div>
                    </div>
                    
                    <!-- Hidden field for parent comment ID -->
                    <input type="hidden" name="parent_id" id="parent_id" value="">
                </div>
                
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-paper-plane me-2"></i>Submit Comment
                </button>
            </form>
        </div>

        <!-- Back to blog link -->
        <div class="text-center mt-5">
            <a href="{% url 'index' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Blog
            </a>
        </div>
    </div>

    <!-- JavaScript for Reply functionality -->
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get all reply buttons
            const replyButtons = document.querySelectorAll('.reply-btn');
            
            // Add click event to each reply button
            replyButtons.forEach(function(button) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Get comment ID and name from data attributes
                    const commentId = this.getAttribute('data-comment-id');
                    const commentName = this.getAttribute('data-comment-name');
                    
                    // Set the parent_id in the hidden field
                    document.getElementById('parent_id').value = commentId;
                    
                    // Update the reply info
                    document.getElementById('reply-name').textContent = commentName;
                    document.getElementById('reply-info').style.display = 'block';
                    
                    // Smooth scroll to the comment form
                    document.getElementById('comment-form').scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                    
                    // Focus on the comment textarea after scrolling
                    setTimeout(function() {
                        document.getElementById('InputComment').focus();
                    }, 500);
                });
            });
        });

        // Cancel reply function
        function cancelReply() {
            // Clear the parent_id
            document.getElementById('parent_id').value = '';
            
            // Hide the reply info
            document.getElementById('reply-info').style.display = 'none';
            
            // Clear the reply name
            document.getElementById('reply-name').textContent = '';
        }

        // Show success message after comment submission (if redirected back)
        {% if request.GET.comment_added %}
        window.addEventListener('load', function() {
            alert('Your comment has been posted successfully!');
        });
        {% endif %}
    </script>
</body>
</html>